<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>middlewares.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createPhoneNumber">createPhoneNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#express">express</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getApplication">getApplication</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getDomain">getDomain</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEndpoint">getEndpoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOrCreateApplication">getOrCreateApplication</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOrCreateDomain">getOrCreateDomain</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOrCreateEndpoint">getOrCreateEndpoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOrCreatePhoneNumber">getOrCreatePhoneNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getPhoneNumber">getPhoneNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#koa">koa</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#listApplications">listApplications</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#listDomains">listDomains</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#listEndpoints">listEndpoints</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#listPhoneNumbers">listPhoneNumbers</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">middlewares.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const util = require('util');
const _ = require('lodash');
const debug = require('debug')('bandwidth:middlewares');
const Bandwidth = require('node-bandwidth');
const application = require('./application');
const phoneNumber = require('./phone-number');
const endpoint = require('./endpoint');

async function callbackEvent(callbackHandler, eventData, ctx) {
	try {
		const handler = callbackHandler[eventData.eventType];
		if (handler) {
			await handler(eventData, ctx);
		} else {
			debug('Unhandled event "%s"', eventData.eventType);
		}
	}	catch (err) {
		debug(err);
	}
}

/**
 * @summary Koa middleware
 * @description This middleware will create application instance (or get existing by name) on Bandwidth server and configure callback routes.
 * It adds to koa context next keys:
 * &lt;ul>
 * &lt;li>bandwidthApi - Bandwidth API instance,&lt;/li>
 * &lt;li>applicationId - Application Id on Bandwidth server,&lt;/li>
 * &lt;li>phoneNumber - reserved phone number which events will be handled by this application (only if options.phoneNumber is defined),&lt;/li>
 * &lt;li>domainId - SIP domain Id (only if options.sip.domain is defined),&lt;/li>
 * &lt;li>getOrCreateEndpoint(sipAccount) - function to get sip endpoint data by sip account name (it will create new account if it is absent, only if options.sip.domain is defined).&lt;/li>
 * &lt;/ul>
 * @example
 * // Samples of usage of ctx.getOrCreateEndpoint:
 * const endpoint1 = await ctx.getOrCreateEndpoint('sipUser1'); // if enpoint sipUser1 is missing new enpoint will be created with random password
 * const endpoint2 = await ctx.getOrCreateEndpoint({name: 'sipUser1' password: '123456'}); // if enpoint sipUser2 is missing new enpoint will be created with given password
 * @param {object} options middleware's options
 * @param {string} options.name application name on Bandwidth server
 * @param {object} options.auth Auth data fof Bandwidth API
 * @param {string} options.auth.userId User ID
 * @param {string} options.auth.apiToken API token
 * @param {string} options.auth.apiSecret API secret
 * @param {object} [options.phoneNumber] Options for reserving phone number. If it is missing no phone number will be reserved.
 * @param {string} [options.phoneNumber.name] Name of reserved phone number
 * @param {string} [options.phoneNumber.phoneType] 'local' or 'tollFree'
 * @param {string} [options.phoneNumber.*] Other options will be passed directly to POST /availableNumbers/local or /availableNumbers/tollFree (see for more details http://dev.bandwidth.com/ap-docs/methods/availableNumbers/postAvailableNumbersLocal.html)
 * @param {object} [options.sip] Sip domain options
 * @param {string} [options.sip.domain] Sip domain name to use (not more than 16 low cased symbols )
 * @param {function|object} [options.callCallback] Function like async function(eventData, ctx){} or object like {'eventName': async function eventHandler(eventData, ctx){}} to handle calls callback events
 * @param {function|object} [options.messageCallback] Function like async function(eventData, ctx){} or object like {'eventName': async function eventHandler(eventData, ctx){}} to handle message callback events
 * @example
 *app.use(middlewares.koa({
 *	name: 'My app',
 *	auth: {userId: 'bandwidthUserId', apiToken: 'bandwidthApiToken', apiSecret: 'bandwidthSecret'},
 *	phoneNumber: {
 *		phoneType: 'local',
 *		areaCode: '910'
 *	},
 *	callCallback: async (data, ctx) => {
 *		// Handle calls events here
 *		if(data.eventType === 'answer' &amp;&amp; ctx.phoneNumber === data.to){
 *			console.log('Answered');
 *		}
 *	}
 *}));
 *
 *app.use(middlewares.koa({
 *	name: 'My app1',
 *	auth: {userId: 'bandwidthUserId', apiToken: 'bandwidthApiToken', apiSecret: 'bandwidthSecret'},
 *	phoneNumber: {
 *		phoneType: 'local',
 *		state: 'NC',
 *		city: 'Cary'
 *	},
 *	callCallback: {
 *		answer: async (data, {phoneNumber}) => {
 *			// Handle event 'answer'
 *			if(phoneNumber === data.to){
 *				console.log('Answered');
 *			}
 *		}
 *	}
 *}));
 */
function koa(options) {
	return async (ctx, next) => {
		if (!options.auth) {
			throw new Error('Missing Bandwidth credentials. Please fill middleware options: auth.userId, auth.apiToken and auth.apiSecret');
		}
		const getOrCreateApplication = _.memoize(application.getOrCreateApplication, () => `${options.name}##${ctx.host}`);
		const getOrCreatePhoneNumber = _.memoize(phoneNumber.getOrCreatePhoneNumber, () => ctx.applicationId);
		ctx.bandwidthApi = new Bandwidth(options.auth);
		ctx.applicationId = await getOrCreateApplication(ctx.bandwidthApi, options.name, ctx.host, util.isUndefined(options.useHttps) ? true : options.useHttps);
		if (options.phoneNumber) {
			ctx.phoneNumber = await getOrCreatePhoneNumber(ctx.bandwidthApi, ctx.applicationId, _.omit(options.phoneNumber, 'phoneType'), options.phoneNumber.phoneType || 'local');
		}
		if (options.sip &amp;&amp; options.sip.domain) {
			const getOrCreateDomain = _.memoize(endpoint.getOrCreateDomain, () => options.sip.domain);
			ctx.domainId = await getOrCreateDomain(ctx.bandwidthApi, options.sip.domain);
			ctx.getOrCreateEndpoint = endpoint.getOrCreateEndpoint.bind(null, ctx.bandwidthApi, ctx.applicationId, ctx.domainId);
		}
		const body = (ctx.request || ctx).body;
		if (ctx.method === 'POST' &amp;&amp; body) {
			const handleEvent = async (path, handler) => {
				if (ctx.path === path &amp;&amp; handler) {
					if (util.isFunction(handler)) {
						try {
							debug(body);
							await handler(body, ctx);
						} catch (err) {
							debug(err);
						}
						return true;
					} else if (util.isObject(handler)) {
						debug(body);
						await callbackEvent(handler, body, ctx);
						return true;
					}
				}
				return false;
			};
			const [messageResult, callResult] = await Promise.all([handleEvent(application.MESSAGE_CALLBACK_PATH, options.messageCallback),
				handleEvent(application.CALL_CALLBACK_PATH, options.callCallback)]);
			if (messageResult || callResult)	{
				ctx.body = '';
				ctx.sendResponse = '';
				return;
			}
		}
		await next();
	};
}

/**
 * @summary Express middleware
 * @description This middleware will create application instance (or get existing by name) on Bandwidth server and configure callback routes.
 * It adds to request instance next keys:
 * &lt;ul>
 * &lt;li>bandwidthApi - Bandwidth API instance,&lt;/li>
 * &lt;li>applicationId - Application Id on Bandwidth server,&lt;/li>
 * &lt;li>phoneNumber - reserved phone number which events will be handled by this application (only if options.phoneNumber is defined),&lt;/li>
 * &lt;li>domainId - SIP domain Id (only if options.sip.domain is defined),&lt;/li>
 * &lt;li>getOrCreateEndpoint(sipAccount) - function to get sip endpoint data by sip account name (it will create new account if it is absent, only if options.sip.domain is defined).&lt;/li>
 * &lt;/ul>
 * @example
 * // Samples of usage of req.getOrCreateEndpoint:
 * req.getOrCreateEndpoint('sipUser1').then(endpoint => {}); // if enpoint sipUser1 is missing new enpoint will be created with random password
 * req.getOrCreateEndpoint({name: 'sipUser1' password: '123456'}).then(endpoint => {}); // if enpoint sipUser2 is missing new enpoint will be created with given password
 * @param {object} options middleware's options
 * @param {string} options.name application name on Bandwidth server
 * @param {object} options.auth Auth data fof Bandwidth API
 * @param {string} options.auth.userId User ID
 * @param {string} options.auth.apiToken API token
 * @param {string} options.auth.apiSecret API secret
 * @param {object} [options.phoneNumber] Options for reserving phone number. If it is missing no phone number will be reserved.
 * @param {string} [options.phoneNumber.name] Name of reserved phone number
 * @param {string} [options.phoneNumber.phoneType] 'local' or 'tollFree'
 * @param {string} [options.phoneNumber.*] Other options will be passed directly to POST /availableNumbers/local or /availableNumbers/tollFree (see for more details http://dev.bandwidth.com/ap-docs/methods/availableNumbers/postAvailableNumbersLocal.html)
 * @param {object} [options.sip] Sip domain options
 * @param {string} [options.sip.domain] Sip domain name to use (not more than 16 low cased symbols )
 * @param {function|object} [options.callCallback] Function like async function(eventData, req){} or object like {'eventName': async function eventHandler(eventData, req){}} to handle calls callback events
 * @param {function|object} [options.messageCallback] Function like async function(eventData, req){} or object like {'eventName': async function eventHandler(eventData, req){}} to handle message callback events
 * @example
 *app.use(middlewares.express({
 *	name: 'My app',
 *	auth: {userId: 'bandwidthUserId', apiToken: 'bandwidthApiToken', apiSecret: 'bandwidthSecret'},
 *	phoneNumber: {
 *		phoneType: 'local',
 *		areaCode: '910'
 *	},
 *	callCallback: async (data, ctx) => {
 *		// Handle calls events here
 *		if(data.eventType === 'answer' &amp;&amp; ctx.phoneNumber === data.to){
 *			console.log('Answered');
 *		}
 *	}
 *}));
 *
 *app.use(middlewares.koa({
 *	name: 'My app1',
 *	auth: {userId: 'bandwidthUserId', apiToken: 'bandwidthApiToken', apiSecret: 'bandwidthSecret'},
 *	phoneNumber: {
 *		phoneType: 'local',
 *		state: 'NC',
 *		city: 'Cary'
 *	},
 *	callCallback: {
 *		answer: async (data, {phoneNumber}) => {
 *			// Handle event 'answer'
 *			if(phoneNumber === data.to){
 *				console.log('Answered');
 *			}
 *		}
 *	}
 *}));
 */
function express(options) {
	const middleware = koa(options);
	return (req, res, next) => {
		middleware(req, async () => next()).then(() => {
			if (!util.isUndefined(req.sendResponse)) {
				res.send(req.sendResponse);
			}
		}, err => next(err));
	};
}

module.exports = {koa, express};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed May 17 2017 10:55:20 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
